rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ğŸ” ä½¿ç”¨è€…æ–‡ä»¶ï¼šä»»ä½•ç™»å…¥è€…å¯è®€å–è‡ªå·±çš„å€‹äººè³‡æ–™ï¼Œä¸¦ä¸”åªèƒ½å¯«å…¥è‡ªå·±çš„è³‡æ–™ã€‚
    // ç®¡ç†å“¡ç›¸é—œçš„ç‰¹æ®Šæ¬Šé™ï¼ˆå¦‚ä¿®æ”¹ä»–äººè³‡æ–™ï¼‰æ‡‰è¬¹æ…è™•ç†ï¼Œæˆ–é€é Cloud Functions å¯¦ç¾ã€‚
    match /users/{userId} {
      allow read: if request.auth != null;
      // å…è¨±ä½¿ç”¨è€…è®€å–è‡ªå·±çš„ isAdmin ç‹€æ…‹ï¼Œæˆ–å…è¨±ç®¡ç†å“¡è®€å–æ‰€æœ‰ä½¿ç”¨è€…è³‡æ–™
      // allow read: if request.auth != null && (request.auth.uid == userId || request.auth.token.admin == true);
      allow write: if request.auth != null && request.auth.uid == userId;
      // å¦‚æœéœ€è¦è®“ç®¡ç†å“¡å¯ä»¥æ›´æ–°ä½¿ç”¨è€…çš„ isAdmin ç‹€æ…‹ï¼ˆä¾‹å¦‚é€éå¾Œå°ä»‹é¢ï¼‰
      // å‰‡éœ€è¦æ›´ç´°ç·»çš„è¦å‰‡ï¼Œä¾‹å¦‚ï¼š
      // allow update: if request.auth != null && (request.auth.uid == userId ||
      // (request.auth.token.admin == true && request.resource.data.keys().hasAny(['isAdmin'])));
    }

    // ğŸ“˜ æ–‡ç« æ–‡ä»¶ï¼š
    match /articles/{articleId} {
      allow read: if true; // ä»»ä½•äººéƒ½å¯ä»¥è®€å–æ–‡ç« 
      allow create: if request.auth != null;  // ç™»å…¥è€…å¯ä»¥æŠ•ç¨¿ (status é è¨­æ‡‰ç‚º pending)
      // åªæœ‰ token ä¸­æœ‰ admin:true å®£å‘Šçš„ä½¿ç”¨è€…å¯ä»¥æ›´æ–°æ–‡ç«  (ä¾‹å¦‚è®Šæ›´ status, isFeatured)
      allow update: if request.auth != null && request.auth.token.admin == true;
      // åªæœ‰ç®¡ç†å“¡å¯ä»¥åˆªé™¤æ–‡ç«  (ç›®å‰è¨­å®šç‚º falseï¼Œè‹¥è¦é–‹æ”¾å‰‡æ”¹ç‚º admin åˆ¤æ–·)
      allow delete: if request.auth != null && request.auth.token.admin == true; // æˆ–è€… if false;
    }

    // ğŸ”” é€šçŸ¥æ–‡ä»¶ï¼š
    match /notifications/{notificationId} {
      // ä½¿ç”¨è€…å¯ä»¥è®€å–è‡ªå·±çš„é€šçŸ¥ï¼Œç®¡ç†å“¡å¯ä»¥è®€å–æ‰€æœ‰é€šçŸ¥ (ç”¨æ–¼èšåˆæŸ¥è©¢æˆ–å¾Œå°ç®¡ç†)
      allow read: if request.auth != null &&
                     (request.auth.uid == resource.data.uid || request.auth.token.admin == true);
      // åªæœ‰ç®¡ç†å“¡å¯ä»¥å»ºç«‹é€šçŸ¥ (ä¾‹å¦‚æ–‡ç« å¯©æ ¸é€šé/é€€å›çš„é€šçŸ¥)
      allow create: if request.auth != null && request.auth.token.admin == true;
      // ä½¿ç”¨è€…å¯ä»¥æ›´æ–°è‡ªå·±é€šçŸ¥çš„ 'read' ç‹€æ…‹ - æš«æ™‚æ”¾å¯¬è¦å‰‡é€²è¡Œèª¿è©¦
      allow update: if request.auth != null && (
        // åŸæœ¬çš„è¦å‰‡ï¼šåªèƒ½æ›´æ–°è‡ªå·±çš„é€šçŸ¥
        (request.auth.uid == resource.data.uid && request.resource.data.keys().hasOnly(['read'])) ||
        // æš«æ™‚å…è¨±ç®¡ç†å“¡æ›´æ–°æ‰€æœ‰é€šçŸ¥ï¼ˆç”¨æ–¼èª¿è©¦ï¼‰
        request.auth.token.admin == true
      );
      allow delete: if false; // é€šå¸¸ä¸å…è¨±å®¢æˆ¶ç«¯åˆªé™¤é€šçŸ¥ï¼Œæˆ–åªå…è¨±ç®¡ç†å“¡
    }

    // âœ‹ å…¶ä»–æ‰€æœ‰æœªæ˜ç¢ºå®šç¾©è·¯å¾‘çš„æ–‡ä»¶é è¨­é—œé–‰æ‰€æœ‰è®€å¯«æ¬Šé™
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 